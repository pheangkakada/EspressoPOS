<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EspressoPOS | Login</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root {
            --primary: #7C4DFF;
            --primary-hover: #6A42D0;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --font-main: 'Inter', -apple-system, system-ui, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .terminal-container {
            display: flex;
            width: 850px;
            height: 550px;
            background: var(--bg-card);
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .brand-section {
            flex: 0.8;
            background-color: var(--primary);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            padding: 60px;
            position: relative;
        }

        .brand-section h1 {
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -1.5px;
            margin-bottom: 10px;
            line-height: 1;
        }

        .brand-section p { font-size: 1rem; opacity: 0.8; max-width: 200px; }

        .form-section {
            flex: 1.2;
            padding: 50px 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: #ffffff;
        }

        .form-header { margin-bottom: 30px; }
        .form-header h2 { font-size: 1.5rem; font-weight: 700; }

        .staff-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 12px;
            display: block;
        }

        .staff-selection {
            display: flex;
            gap: 16px;
            margin-bottom: 30px;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: thin;
        }

        .staff-avatar {
            width: 52px;
            height: 52px;
            border-radius: 12px;
            background: #f8fafc;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            flex-shrink: 0;
            user-select: none;
        }

        .staff-avatar:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); }
        .staff-avatar.active { background: var(--primary); border-color: var(--primary); color: white; }

        .tooltip {
            position: absolute; bottom: -28px; font-size: 0.7rem; background: var(--text-main);
            color: white; padding: 4px 8px; border-radius: 4px; opacity: 0; visibility: hidden; transition: 0.2s; white-space: nowrap; z-index: 10;
        }
        .staff-avatar:hover .tooltip { opacity: 1; visibility: visible; }

        .user-pill {
            display: none; background: #f5f3ff; border: 1px solid #ddd6fe;
            padding: 12px 16px; border-radius: 12px; margin-bottom: 20px; align-items: center; justify-content: space-between;
        }
        .user-pill.visible { display: flex; }

        .input-group { margin-bottom: 20px; }
        .input-group.hide { display: none; }
        .input-group label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; }

        .input-field {
            width: 100%; padding: 12px 16px; border: 1px solid var(--border);
            border-radius: 10px; font-size: 1rem; background: #f8fafc; transition: all 0.2s;
        }
        .input-field:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(124, 77, 255, 0.1); }

        .btn-primary {
            width: 100%; padding: 14px; background: var(--primary); color: white;
            border: none; border-radius: 10px; font-size: 0.95rem; font-weight: 700; cursor: pointer;
            transition: background 0.2s;
        }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; }

        .notify {
            position: fixed; top: 24px; left: 50%; transform: translateX(-50%);
            background: #ef4444; color: white; padding: 12px 24px; border-radius: 10px;
            font-weight: 600; opacity: 0; visibility: hidden; transition: 0.3s; z-index: 1000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .notify.active { opacity: 1; visibility: visible; top: 40px; }
        .notify.success { background: #10b981; }

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(4px);
            z-index: 100; display: none; align-items: center; justify-content: center;
        }
        .modal-card { width: 440px; background: white; border-radius: 20px; padding: 32px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .log-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
    </style>
</head>
<body>

    <div id="notify" class="notify">Notification</div>

    <div class="terminal-container">
        <aside class="brand-section">
            <h1>Paint Coffee<br>Terminal</h1>
            <p>Station Terminal #402</p>
        </aside>

        <main class="form-section">
            <header class="form-header">
                <h2>Terminal Access</h2>
                <p>Select your profile to begin.</p>
            </header>

            <span class="staff-label">Select Operator</span>
            <div id="staffList" class="staff-selection">
                <div style="font-size: 13px; color: var(--text-muted); padding: 10px 0;">Connecting to server...</div>
            </div>

            <form id="loginForm">
                <div id="selectedBadge" class="user-pill">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="material-icons-round" style="color: var(--primary)">account_circle</span>
                        <div style="display: flex; flex-direction: column;">
                            <strong id="badgeName">User</strong>
                            <span id="badgeRole" style="font-size: 10px; color: #666; text-transform: uppercase;">Role</span>
                        </div>
                    </div>
                    <button type="button" style="background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:12px; font-weight: 600;" onclick="resetForm()">
                        CHANGE
                    </button>
                </div>

                <div id="idGroup" class="input-group">
                    <label>Operator ID</label>
                    <input type="text" id="username" class="input-field" placeholder="e.g. admin" autocomplete="off">
                </div>

                <div class="input-group">
                    <label>Security PIN</label>
                    <input type="password" id="password" class="input-field" placeholder="••••" required>
                </div>

                <button type="submit" id="loginBtn" class="btn-primary">Initialize Session</button>
            </form>

            <button style="margin-top:20px; background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:12px; text-decoration: underline;" onclick="toggleHistory(true)">View Recent System Activity</button>
        </main>
    </div>

    <div id="historyOverlay" class="modal-overlay" onclick="toggleHistory(false)">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-size: 1.2rem; font-weight: 700;">Recent Activity</h2>
                <button onclick="toggleHistory(false)" style="background: none; border: none; cursor: pointer;">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div id="logContainer">Loading logs...</div>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const API_BASE = 'https://nodetest-backend-jwqo.onrender.com/api';
        
        // DOM Elements
        const staffListEl = document.getElementById('staffList');
        const usernameEl = document.getElementById('username');
        const passwordEl = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const idGroupEl = document.getElementById('idGroup');
        const selectedBadgeEl = document.getElementById('selectedBadge');
        const badgeNameEl = document.getElementById('badgeName');
        const badgeRoleEl = document.getElementById('badgeRole');

        // 1. Initialize: Load Users from Database
        async function loadStaff() {
            try {
                const res = await fetch(`${API_BASE}/users`);
                if (!res.ok) throw new Error("Failed to fetch");
                
                const users = await res.json();
                staffListEl.innerHTML = '';

                if (users.length === 0) {
                    staffListEl.innerHTML = '<span style="font-size:12px; color: orange;">No users found. Login manually.</span>';
                    return;
                }

                users.forEach(user => {
                    const avatar = document.createElement('div');
                    avatar.className = 'staff-avatar';
                    
                    // Initials
                    const initial = user.username ? user.username.charAt(0).toUpperCase() : '?';
                    avatar.innerHTML = `${initial} <span class="tooltip">${user.username}</span>`;
                    
                    // Click Handler
                    avatar.addEventListener('click', () => selectStaff(avatar, user.username, user.role));
                    
                    staffListEl.appendChild(avatar);
                });
            } catch (err) {
                console.error("Load users failed", err);
                staffListEl.innerHTML = '<span style="font-size:12px; color: red;">Server Offline. Check API.</span>';
            }
        }

        // 2. Select User Logic
        function selectStaff(element, username, role) {
            // UI Updates
            document.querySelectorAll('.staff-avatar').forEach(n => n.classList.remove('active'));
            element.classList.add('active');
            
            // Set Form Data
            usernameEl.value = username;
            
            // Visual Toggle
            idGroupEl.classList.add('hide');
            selectedBadgeEl.classList.add('visible');
            
            // Update Badge Info
            badgeNameEl.textContent = username;
            badgeRoleEl.textContent = role || 'Operator';
            
            // Focus Password
            passwordEl.value = '';
            passwordEl.focus();
        }

        // 3. Reset Form Logic
        window.resetForm = function() {
            document.querySelectorAll('.staff-avatar').forEach(n => n.classList.remove('active'));
            idGroupEl.classList.remove('hide');
            selectedBadgeEl.classList.remove('visible');
            usernameEl.value = "";
            passwordEl.value = "";
            usernameEl.focus();
        }

        // 4. Authentication Logic
        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            
            const username = usernameEl.value.trim();
            const password = passwordEl.value.trim();

            if(!username || !password) {
                showNotify("Please enter credentials");
                return;
            }

            // UI Loading State
            loginBtn.textContent = "Verifying Credentials...";
            loginBtn.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await res.json();

                if (res.ok) {
                    showNotify("Access Granted", true);
                    
                    // Save Session
                    localStorage.setItem('username', data.user.username);
                    localStorage.setItem('role', data.user.role);
                    localStorage.setItem('token', 'admin_secret_key'); // Simple token simulation

                    // Redirect based on role
                    setTimeout(() => {
                        if (data.user.role === 'admin' || data.user.role === 'manager') {
                            window.location.href = 'admin.html';
                        } else {
                            window.location.href = 'pos.html';
                        }
                    }, 800);
                } else {
                    showNotify(data.error || "Invalid ID or PIN");
                    loginBtn.textContent = "Initialize Session";
                    loginBtn.disabled = false;
                    passwordEl.value = ''; // Clear password on fail
                    passwordEl.focus();
                }
            } catch (err) {
                console.error(err);
                showNotify("Server Connection Failed");
                loginBtn.textContent = "Initialize Session";
                loginBtn.disabled = false;
            }
        };

        // 5. Notification Toast
        function showNotify(msg, isSuccess = false) {
            const n = document.getElementById('notify');
            n.textContent = msg;
            n.className = isSuccess ? 'notify active success' : 'notify active';
            
            // Clear existing timeout if any (simple debounce)
            if(window.notifyTimeout) clearTimeout(window.notifyTimeout);
            
            window.notifyTimeout = setTimeout(() => {
                n.classList.remove('active');
            }, 3000);
        }

        // 6. History Logs (Bonus Feature)
        window.toggleHistory = async function(show) {
            const overlay = document.getElementById('historyOverlay');
            if (show) {
                overlay.style.display = 'flex';
                const logContainer = document.getElementById('logContainer');
                logContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">Fetching logs...</div>';
                
                try {
                    const res = await fetch(`${API_BASE}/invoices`);
                    if(!res.ok) throw new Error("Failed");
                    
                    const invs = await res.json();
                    
                    if(invs.length === 0) {
                        logContainer.innerHTML = '<div style="text-align:center; padding:20px;">No recent activity.</div>';
                        return;
                    }

                    // Show last 5 invoices as "activity"
                    logContainer.innerHTML = invs.slice(0, 5).map(i => `
                        <div class="log-item">
                            <div>
                                <strong>Invoice #${i.invoiceId || i._id.substring(0,6)}</strong><br>
                                <span style="font-size:11px; color:#666;">by ${i.createdBy || 'Staff'}</span>
                            </div>
                            <div style="text-align:right;">
                                <strong>$${i.total ? i.total.toFixed(2) : '0.00'}</strong><br>
                                <span style="font-size:11px; color:#666;">${new Date(i.date).toLocaleTimeString()}</span>
                            </div>
                        </div>
                    `).join('');
                } catch (e) { 
                    document.getElementById('logContainer').innerHTML = '<div style="color:red; text-align:center;">Failed to load logs. Server might be down.</div>';
                }
            } else { 
                overlay.style.display = 'none'; 
            }
        }

        // Initialize
        window.onload = loadStaff;
    </script>
</body>
</html>